<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
<script src="https://jsuites.net/v4/jsuites.js"></script>
<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />

<div id="spreadsheet"></div>

<script>
  const CELL_NO = {
    ID: 0,
    STATUS: 1,
    DATE: 2,
    PROJECT: 3,
    CATEGORY: 4,
    TASK: 5,
    PLANH: 6,
    PLANM: 7,
    SPENT: 8,
    START: 9,
    END: 10
  };
  var editionend = function(instance, cell, x, y, value) {
    var cellName = table.getHeader(x);
    if(cellName === 'end'){
      openclose(x,y);
      updateid();
      sortbyid();
      updateid();
    }
  }
  var openclose = function(x,y){

      var start = table.getValue(jexcel.getColumnNameFromId([x-1,y]));
      var end = table.getValue(jexcel.getColumnNameFromId([x,y]));

      if(start.length !== 0 && end.length !== 0){
        close(y);
      }else{
        open(y);
    }
  }

    var close = function(y){
      for(var x=CELL_NO.STATUS;x<=table.getRowData(y).length;x++){
        table.setStyle(jexcel.getColumnNameFromId([x,y]),'background-color','grey');
      }
      table.setValueFromCoords(CELL_NO.STATUS,y,'done',true);
    }

    var open = function(y){
      for(var x=CELL_NO.STATUS;x<=table.getRowData(y).length;x++){
        table.setStyle(jexcel.getColumnNameFromId([x,y]),'background-color','white');
      }
      table.setValueFromCoords(CELL_NO.STATUS,y,'working',true);
    }
    
    var updateid = function(){
      for(var y=0;y<table.getColumnData(1).length;y++){
        console.log(y);
        var id = 0;
        var status = table.getValue(jexcel.getColumnNameFromId([CELL_NO.STATUS,y]));
        var offset = 10000;
        if(status === "done"){
          offset = 30000;
        }
        id = y + offset;
        
        table.setValueFromCoords(CELL_NO.ID,y,id,true)
        
      }
    }
    
    var sortbyid = function(){
      table.orderBy(CELL_NO.ID,true);
    }


  
  
var data = [
    ['11000','working','2019-02-12','projctX','coding','Jazz', '1','60','60','12:00',  '13:00'],
    ['21000','done','2018-07-11','projctY','design','Civic', '2','120','60','13:00',  '14:00'],
];

var table = jspreadsheet(document.getElementById('spreadsheet'), {
    data:data,
    columns: [
        { type: 'numeric', title:'#', width:0},
        { type: 'text', title:'status', width:100},
        { type: 'calendar', title:'date', width:100 },
        { type: 'text', title:'project', width:100 },
        { type: 'text', title:'category', width:100 },
        { type: 'text', title:'task', width:300 },
        { type: 'numeric', title:'plan(h)', width:70},
        { type: 'numeric', title:'plan(m)', width:70},
        { type: 'numeric', title:'spent(m)', width:70},
        { type: 'text', title:'start', width:100 },
        { type: 'text', title:'end', width:100 },
     ],
  oneditionend : editionend,
});
</script>